// Example Jenkinsfile demonstrating the Devlogs plugin
// This shows the recommended pipeline-level configuration using credentialsId

pipeline {
    agent any

    // Configure devlogs once at the pipeline level - all stages are automatically captured
    // The credentialsId parameter looks up a "Secret text" credential containing the OpenSearch URL
    options {
        devlogs(credentialsId: 'devlogs-opensearch-url')
    }

    stages {
        stage('Build') {
            steps {
                echo 'Starting build...'
                sh 'npm install'
                sh 'npm run build'
                echo 'Build complete!'
            }
        }

        stage('Test') {
            steps {
                echo 'Running tests...'
                sh 'npm test'
                echo 'Tests complete!'
            }
        }

        stage('Deploy to Staging') {
            when {
                not {
                    branch 'main'
                }
            }
            steps {
                echo 'Deploying to staging...'
                sh './deploy-staging.sh'
            }
        }

        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                echo 'Deploying to production...'
                sh './deploy-production.sh'
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
